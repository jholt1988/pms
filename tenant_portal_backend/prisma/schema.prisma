
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  password       String
  role           Role     @default(TENANT)
  requests       MaintenanceRequest[]
  lease          Lease?
  payments       Payment[]
  conversations  ConversationParticipant[]
  sentMessages   Message[] @relation("sentMessages")
  rentalApplications RentalApplication[]
  expenses       Expense[] @relation("RecordedExpenses")
}

model Property {
  id      Int    @id @default(autoincrement())
  name    String
  address String
  units   Unit[]
  rentalApplications RentalApplication[]
  expenses Expense[]
}

model Unit {
  id         Int      @id @default(autoincrement())
  name       String // e.g., "Apt 101"
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId Int
  lease      Lease?
  rentalApplications RentalApplication[]
  expenses   Expense[]
}

model Lease {
  id          Int      @id @default(autoincrement())
  startDate   DateTime
  endDate     DateTime
  rentAmount  Float
  tenant      User     @relation(fields: [tenantId], references: [id])
  tenantId    Int      @unique // A user can only have one lease
  unit        Unit     @relation(fields: [unitId], references: [id])
  unitId      Int      @unique // A unit can only have one lease
  payments    Payment[]
  invoices    Invoice[]
}

model MaintenanceRequest {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  status      Status   @default(PENDING)
  author      User     @relation(fields: [authorId], references: [id])
  authorId    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id        Int      @id @default(autoincrement())
  description String
  amount    Float
  dueDate   DateTime
  status    String   @default("UNPAID") // UNPAID, PAID, OVERDUE
  lease     Lease    @relation(fields: [leaseId], references: [id])
  leaseId   Int
  payments  Payment[]
}

model Payment {
  id        Int      @id @default(autoincrement())
  amount    Float
  paymentDate      DateTime @default(now())
  status    String // e.g., "COMPLETED", "FAILED"
  invoice   Invoice?  @relation(fields: [invoiceId], references: [id])
  invoiceId Int?
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  lease     Lease?    @relation(fields: [leaseId], references: [id])
  leaseId   Int?
}

model Conversation {
  id           Int      @id @default(autoincrement())
  participants ConversationParticipant[]
  messages     Message[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ConversationParticipant {
  user           User         @relation(fields: [userId], references: [id])
  userId         Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId Int

  @@id([userId, conversationId])
}

model Message {
  id             Int      @id @default(autoincrement())
  content        String
  sender         User     @relation("sentMessages", fields: [senderId], references: [id])
  senderId       Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId Int
  createdAt      DateTime @default(now())
}

model RentalApplication {
  id                 Int                @id @default(autoincrement())
  applicant          User               @relation(fields: [applicantId], references: [id])
  applicantId        Int
  property           Property           @relation(fields: [propertyId], references: [id])
  propertyId         Int
  unit               Unit               @relation(fields: [unitId], references: [id])
  unitId             Int
  status             ApplicationStatus  @default(PENDING)
  applicationDate    DateTime           @default(now())
  fullName           String
  email              String
  phoneNumber        String
  income             Float
  employmentStatus   String
  previousAddress    String
  qualificationStatus QualificationStatus? // Added for screening
  recommendation     Recommendation?    // Added for screening
  screeningDetails   String?            // Added for screening
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

model Expense {
  id          Int            @id @default(autoincrement())
  property    Property       @relation(fields: [propertyId], references: [id])
  propertyId  Int
  unit        Unit?          @relation(fields: [unitId], references: [id])
  unitId      Int?
  description String
  amount      Float
  date        DateTime
  category    ExpenseCategory
  recordedBy  User           @relation("RecordedExpenses", fields: [recordedById], references: [id])
  recordedById Int
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

enum Status {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum Role {
  TENANT
  PROPERTY_MANAGER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum QualificationStatus {
  QUALIFIED
  NOT_QUALIFIED
}

enum Recommendation {
  RECOMMEND_RENT
  DO_NOT_RECOMMEND_RENT
}

enum ExpenseCategory {
  MAINTENANCE
  UTILITIES
  TAXES
  INSURANCE
  REPAIRS
  OTHER
}
