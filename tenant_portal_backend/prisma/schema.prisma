// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        Int                         @id @default(autoincrement())
  username                  String                      @unique
  password                  String
  role                      Role                        @default(TENANT)
  failedLoginAttempts       Int                         @default(0)
  lockoutUntil              DateTime?
  mfaEnabled                Boolean                     @default(false)
  mfaSecret                 String?
  mfaTempSecret             String?
  passwordUpdatedAt         DateTime                    @default(now())
  lastLoginAt               DateTime?
  requests                  MaintenanceRequest[]
  lease                     Lease?
  payments                  Payment[]
  conversations             ConversationParticipant[]
  sentMessages              Message[]                   @relation("sentMessages")
  rentalApplications        RentalApplication[]
  expenses                  Expense[]                   @relation("RecordedExpenses")
  paymentMethods            PaymentMethod[]
  screenedApplications      RentalApplication[]         @relation("ScreenedApplications")
  applicationNotes          RentalApplicationNote[]
  securityEvents            SecurityEvent[]
  Technician                Technician[]
  MaintenanceRequestHistory MaintenanceRequestHistory[]
  MaintenanceNote           MaintenanceNote[]
  MaintenancePhoto          MaintenancePhoto[]
  LeaseHistory              LeaseHistory[]
  LeaseDocument             LeaseDocument[]
  LeaseRenewalOffer         LeaseRenewalOffer[]
  LeaseNotice               LeaseNotice[]
  passwordResetTokens       PasswordResetToken[]
  notifications             Notification[]
  documents                 Document[]
  sharedDocuments           Document[]                  @relation("DocumentShares")
  inspections               UnitInspection[]            @relation("Inspector")
  createdInspections        UnitInspection[]            @relation("CreatedBy")
  UnitInspectionPhoto       UnitInspectionPhoto[]
  scheduleEvents            ScheduleEvent[]             @relation("ScheduleEventTenant")
}

model Property {
  id                   Int                    @id @default(autoincrement())
  name                 String
  address              String
  units                Unit[]
  rentalApplications   RentalApplication[]
  expenses             Expense[]
  MaintenanceRequest   MaintenanceRequest[]
  MaintenanceAsset     MaintenanceAsset[]
  MaintenanceSlaPolicy MaintenanceSlaPolicy[]
  Document             Document[]
  UnitInspection       UnitInspection[]
  scheduleEvents       ScheduleEvent[]
}

model Unit {
  id                 Int                  @id @default(autoincrement())
  name               String // e.g., "Apt 101"
  property           Property             @relation(fields: [propertyId], references: [id])
  propertyId         Int
  lease              Lease?
  rentalApplications RentalApplication[]
  expenses           Expense[]
  MaintenanceRequest MaintenanceRequest[]
  MaintenanceAsset   MaintenanceAsset[]
  inspections        UnitInspection[]
  scheduleEvents     ScheduleEvent[]
}

model Lease {
  id                        Int                       @id @default(autoincrement())
  startDate                 DateTime
  endDate                   DateTime
  rentAmount                Float
  status                    LeaseStatus               @default(DRAFT)
  noticePeriodDays          Int                       @default(30)
  moveInAt                  DateTime?
  moveOutAt                 DateTime?
  autoRenew                 Boolean                   @default(false)
  autoRenewLeadDays         Int?
  depositAmount             Float                     @default(0)
  depositHeldAt             DateTime?
  depositReturnedAt         DateTime?
  depositDisposition        DepositDisposition?
  renewalOfferedAt          DateTime?
  renewalDueAt              DateTime?
  renewalAcceptedAt         DateTime?
  terminationReason         String?
  terminationRequestedBy    LeaseTerminationParty?
  terminationEffectiveAt    DateTime?
  rentEscalationPercent     Float?
  rentEscalationEffectiveAt DateTime?
  billingAlignment          BillingAlignment          @default(FULL_CYCLE)
  currentBalance            Float                     @default(0)
  tenant                    User                      @relation(fields: [tenantId], references: [id])
  tenantId                  Int                       @unique // A user can only have one lease
  unit                      Unit                      @relation(fields: [unitId], references: [id])
  unitId                    Int                       @unique // A unit can only have one lease
  payments                  Payment[]
  invoices                  Invoice[]
  recurringSchedule         RecurringInvoiceSchedule?
  autopayEnrollment         AutopayEnrollment?
  history                   LeaseHistory[]
  documents                 LeaseDocument[]
  generalDocuments          Document[]
  renewalOffers             LeaseRenewalOffer[]
  notices                   LeaseNotice[]
  maintenanceRequests       MaintenanceRequest[]

  @@index([status])
  @@index([endDate])
}

model MaintenanceRequest {
  id             Int                         @id @default(autoincrement())
  title          String
  description    String
  status         Status                      @default(PENDING)
  author         User                        @relation(fields: [authorId], references: [id])
  authorId       Int
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  priority       MaintenancePriority         @default(MEDIUM)
  responseDueAt  DateTime?
  dueAt          DateTime?
  acknowledgedAt DateTime?
  completedAt    DateTime?
  property       Property?                   @relation(fields: [propertyId], references: [id])
  propertyId     Int?
  unit           Unit?                       @relation(fields: [unitId], references: [id])
  unitId         Int?
  asset          MaintenanceAsset?           @relation("AssetRequests", fields: [assetId], references: [id])
  assetId        Int?
  assignee       Technician?                 @relation("TechnicianAssignments", fields: [assigneeId], references: [id])
  assigneeId     Int?
  slaPolicy      MaintenanceSlaPolicy?       @relation(fields: [slaPolicyId], references: [id])
  slaPolicyId    Int?
  lease          Lease?                      @relation(fields: [leaseId], references: [id])
  leaseId        Int?
  history        MaintenanceRequestHistory[]
  notes          MaintenanceNote[]
  photos         MaintenancePhoto[]
}

model MaintenanceAsset {
  id                Int                      @id @default(autoincrement())
  property          Property                 @relation(fields: [propertyId], references: [id])
  propertyId        Int
  unit              Unit?                    @relation(fields: [unitId], references: [id])
  unitId            Int?
  name              String
  category          MaintenanceAssetCategory
  manufacturer      String?
  model             String?
  serialNumber      String?
  installDate       DateTime?
  warrantyExpiresAt DateTime?
  notes             String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  requests          MaintenanceRequest[]     @relation("AssetRequests")

  @@unique([propertyId, unitId, name], name: "MaintenanceAsset_property_unit_name_key")
  @@index([propertyId])
  @@index([unitId])
}

model Technician {
  id          Int                         @id @default(autoincrement())
  name        String
  phone       String?
  email       String?
  role        TechnicianRole              @default(IN_HOUSE)
  user        User?                       @relation(fields: [userId], references: [id])
  userId      Int?
  active      Boolean                     @default(true)
  notes       String?
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  assignments MaintenanceRequest[]        @relation("TechnicianAssignments")
  historyFrom MaintenanceRequestHistory[] @relation("HistoryFromAssignee")
  historyTo   MaintenanceRequestHistory[] @relation("HistoryToAssignee")

  @@index([userId])
  @@index([role, active])
}

model MaintenanceSlaPolicy {
  id                    Int                  @id @default(autoincrement())
  name                  String?
  priority              MaintenancePriority
  responseTimeMinutes   Int?
  resolutionTimeMinutes Int
  property              Property?            @relation(fields: [propertyId], references: [id])
  propertyId            Int?
  active                Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  requests              MaintenanceRequest[]

  @@unique([propertyId, priority], name: "MaintenanceSlaPolicy_property_priority_key")
  @@index([priority])
}

model MaintenanceRequestHistory {
  id             Int                @id @default(autoincrement())
  request        MaintenanceRequest @relation(fields: [requestId], references: [id])
  requestId      Int
  changedBy      User?              @relation(fields: [changedById], references: [id])
  changedById    Int?
  fromStatus     Status?
  toStatus       Status?
  fromAssignee   Technician?        @relation("HistoryFromAssignee", fields: [fromAssigneeId], references: [id])
  fromAssigneeId Int?
  toAssignee     Technician?        @relation("HistoryToAssignee", fields: [toAssigneeId], references: [id])
  toAssigneeId   Int?
  note           String?
  createdAt      DateTime           @default(now())

  @@index([requestId, createdAt])
}

model MaintenanceNote {
  id        Int                @id @default(autoincrement())
  request   MaintenanceRequest @relation(fields: [requestId], references: [id])
  requestId Int
  author    User               @relation(fields: [authorId], references: [id])
  authorId  Int
  body      String
  createdAt DateTime           @default(now())

  @@index([requestId, createdAt])
}

model MaintenancePhoto {
  id           Int                @id @default(autoincrement())
  request      MaintenanceRequest @relation(fields: [requestId], references: [id])
  requestId    Int
  uploadedBy   User?              @relation(fields: [uploadedById], references: [id])
  uploadedById Int?
  url          String
  caption      String?
  createdAt    DateTime           @default(now())

  @@index([requestId])
}

model LeaseHistory {
  id            Int          @id @default(autoincrement())
  lease         Lease        @relation(fields: [leaseId], references: [id])
  leaseId       Int
  actor         User?        @relation(fields: [actorId], references: [id])
  actorId       Int?
  fromStatus    LeaseStatus?
  toStatus      LeaseStatus?
  note          String?
  rentAmount    Float?
  depositAmount Float?
  metadata      Json?
  createdAt     DateTime     @default(now())

  @@index([leaseId, createdAt])
}

model LeaseDocument {
  id           Int      @id @default(autoincrement())
  lease        Lease    @relation(fields: [leaseId], references: [id])
  leaseId      Int
  type         String
  url          String
  description  String?
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id])
  uploadedById Int?
  createdAt    DateTime @default(now())

  @@index([leaseId, createdAt])
}

model Document {
  id           Int              @id @default(autoincrement())
  fileName     String
  filePath     String
  category     DocumentCategory
  description  String?
  mimeType     String?
  size         Int?
  uploadedBy   User             @relation(fields: [uploadedById], references: [id])
  uploadedById Int
  lease        Lease?           @relation(fields: [leaseId], references: [id])
  leaseId      Int?
  property     Property?        @relation(fields: [propertyId], references: [id])
  propertyId   Int?
  sharedWith   User[]           @relation("DocumentShares")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([uploadedById])
  @@index([leaseId])
  @@index([propertyId])
  @@index([category])
}

enum DocumentCategory {
  LEASE
  NOTICE
  INVOICE
  MAINTENANCE
  APPLICATION
  OTHER
}

model LeaseRenewalOffer {
  id                Int                @id @default(autoincrement())
  lease             Lease              @relation(fields: [leaseId], references: [id])
  leaseId           Int
  proposedRent      Float
  proposedStart     DateTime
  proposedEnd       DateTime
  escalationPercent Float?
  message           String?
  status            LeaseRenewalStatus @default(OFFERED)
  expiresAt         DateTime?
  respondedAt       DateTime?
  respondedBy       User?              @relation(fields: [respondedById], references: [id])
  respondedById     Int?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([leaseId, status])
  @@index([expiresAt])
}

model LeaseNotice {
  id             Int                       @id @default(autoincrement())
  lease          Lease                     @relation(fields: [leaseId], references: [id])
  leaseId        Int
  type           LeaseNoticeType
  deliveryMethod LeaseNoticeDeliveryMethod
  sentAt         DateTime                  @default(now())
  acknowledgedAt DateTime?
  message        String?
  createdBy      User?                     @relation(fields: [createdById], references: [id])
  createdById    Int?

  @@index([leaseId, type])
}

model Invoice {
  id          Int                       @id @default(autoincrement())
  description String
  amount      Float
  dueDate     DateTime
  status      String                    @default("UNPAID") // UNPAID, PAID, OVERDUE
  lease       Lease                     @relation(fields: [leaseId], references: [id])
  leaseId     Int
  payments    Payment[]
  issuedAt    DateTime                  @default(now())
  externalId  String?                   @unique
  lateFees    LateFee[]
  schedule    RecurringInvoiceSchedule? @relation(fields: [scheduleId], references: [id])
  scheduleId  Int?
}

model Payment {
  id              Int            @id @default(autoincrement())
  amount          Float
  paymentDate     DateTime       @default(now())
  status          String // e.g., "COMPLETED", "FAILED"
  invoice         Invoice?       @relation(fields: [invoiceId], references: [id])
  invoiceId       Int?
  user            User           @relation(fields: [userId], references: [id])
  userId          Int
  lease           Lease?         @relation(fields: [leaseId], references: [id])
  leaseId         Int?
  externalId      String?        @unique
  reconciledAt    DateTime?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId Int?
}

model Conversation {
  id           Int                       @id @default(autoincrement())
  participants ConversationParticipant[]
  messages     Message[]
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
}

model ConversationParticipant {
  user           User         @relation(fields: [userId], references: [id])
  userId         Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId Int

  @@id([userId, conversationId])
}

model Message {
  id             Int          @id @default(autoincrement())
  content        String
  sender         User         @relation("sentMessages", fields: [senderId], references: [id])
  senderId       Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId Int
  createdAt      DateTime     @default(now())
}

model RentalApplication {
  id                    Int                     @id @default(autoincrement())
  applicant             User?                   @relation(fields: [applicantId], references: [id])
  applicantId           Int?
  property              Property                @relation(fields: [propertyId], references: [id])
  propertyId            Int
  unit                  Unit                    @relation(fields: [unitId], references: [id])
  unitId                Int
  status                ApplicationStatus       @default(PENDING)
  applicationDate       DateTime                @default(now())
  fullName              String
  email                 String
  phoneNumber           String
  income                Float
  employmentStatus      String
  previousAddress       String
  creditScore           Int?
  monthlyDebt           Float?
  bankruptcyFiledYear   Int?
  rentalHistoryComments String?
  qualificationStatus   QualificationStatus? // Added for screening
  recommendation        Recommendation? // Added for screening
  screeningDetails      String? // Added for screening
  screeningScore        Float?
  screeningReasons      Json?
  screenedAt            DateTime?
  screenedBy            User?                   @relation("ScreenedApplications", fields: [screenedById], references: [id])
  screenedById          Int?
  manualNotes           RentalApplicationNote[]
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
}

model Expense {
  id           Int             @id @default(autoincrement())
  property     Property        @relation(fields: [propertyId], references: [id])
  propertyId   Int
  unit         Unit?           @relation(fields: [unitId], references: [id])
  unitId       Int?
  description  String
  amount       Float
  date         DateTime
  category     ExpenseCategory
  recordedBy   User            @relation("RecordedExpenses", fields: [recordedById], references: [id])
  recordedById Int
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

enum LeaseStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  RENEWAL_PENDING
  NOTICE_GIVEN
  TERMINATING
  TERMINATED
  HOLDOVER
  CLOSED
}

enum DepositDisposition {
  HELD
  PARTIAL_RETURN
  RETURNED
  FORFEITED
}

enum LeaseTerminationParty {
  MANAGER
  TENANT
  SYSTEM
}

enum BillingAlignment {
  FULL_CYCLE
  PRORATE
}

enum LeaseRenewalStatus {
  OFFERED
  ACCEPTED
  DECLINED
  EXPIRED
  WITHDRAWN
}

enum LeaseNoticeType {
  MOVE_OUT
  RENT_INCREASE
  OTHER
}

enum LeaseNoticeDeliveryMethod {
  EMAIL
  SMS
  PORTAL
  PRINT
  OTHER
}

enum Status {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum MaintenancePriority {
  EMERGENCY
  HIGH
  MEDIUM
  LOW
}

enum MaintenanceAssetCategory {
  HVAC
  PLUMBING
  ELECTRICAL
  APPLIANCE
  STRUCTURE
  SAFETY
  GROUNDS
  OTHER
}

enum TechnicianRole {
  IN_HOUSE
  CONTRACTOR
  VENDOR
}

enum Role {
  TENANT
  PROPERTY_MANAGER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum QualificationStatus {
  QUALIFIED
  NOT_QUALIFIED
}

enum Recommendation {
  RECOMMEND_RENT
  DO_NOT_RECOMMEND_RENT
}

model RentalApplicationNote {
  id            Int               @id @default(autoincrement())
  application   RentalApplication @relation(fields: [applicationId], references: [id])
  applicationId Int
  author        User?             @relation(fields: [authorId], references: [id])
  authorId      Int?
  body          String
  createdAt     DateTime          @default(now())

  @@index([applicationId])
}

enum ExpenseCategory {
  MAINTENANCE
  UTILITIES
  TAXES
  INSURANCE
  REPAIRS
  OTHER
}

model PaymentMethod {
  id                      Int                 @id @default(autoincrement())
  user                    User                @relation(fields: [userId], references: [id])
  userId                  Int
  type                    PaymentMethodType
  provider                PaymentProvider
  providerCustomerId      String?
  providerPaymentMethodId String?
  last4                   String?
  brand                   String?
  expMonth                Int?
  expYear                 Int?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  autopayEnrollments      AutopayEnrollment[]
  payments                Payment[]
}

enum PaymentMethodType {
  CARD
  BANK_ACCOUNT
}

enum PaymentProvider {
  STRIPE
  PLAID
  OTHER
}

model RecurringInvoiceSchedule {
  id               Int              @id @default(autoincrement())
  lease            Lease            @relation(fields: [leaseId], references: [id])
  leaseId          Int              @unique
  amount           Float
  description      String           @default("Monthly Rent")
  frequency        BillingFrequency @default(MONTHLY)
  dayOfMonth       Int? // required for monthly
  dayOfWeek        Int? // optional for weekly
  nextRun          DateTime
  lateFeeAmount    Float? // flat fee
  lateFeeAfterDays Int? // number of days after due date
  active           Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  invoices         Invoice[]
}

enum BillingFrequency {
  MONTHLY
  WEEKLY
}

model LateFee {
  id         Int      @id @default(autoincrement())
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId  Int
  amount     Float
  assessedAt DateTime @default(now())
  waived     Boolean  @default(false)
}

model AutopayEnrollment {
  id              Int           @id @default(autoincrement())
  lease           Lease         @relation(fields: [leaseId], references: [id])
  leaseId         Int           @unique
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId Int
  active          Boolean       @default(true)
  maxAmount       Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model SecurityEvent {
  id        Int               @id @default(autoincrement())
  user      User?             @relation(fields: [userId], references: [id])
  userId    Int?
  username  String?
  type      SecurityEventType
  success   Boolean
  ipAddress String?
  userAgent String?
  metadata  Json?
  createdAt DateTime          @default(now())

  @@index([createdAt])
  @@index([type])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILURE
  LOGIN_LOCKED
  PASSWORD_CHANGED
  MFA_ENROLLMENT_STARTED
  MFA_ENABLED
  MFA_DISABLED
  MFA_CHALLENGE_FAILED
  AUTOPAY_ENABLED
  AUTOPAY_DISABLED
  RECURRING_BILLING_UPDATED
  APPLICATION_SCREENED
  APPLICATION_NOTE_CREATED
}

model Notification {
  id        Int              @id @default(autoincrement())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([type])
}

enum NotificationType {
  RENT_REMINDER
  RENT_OVERDUE
  LEASE_RENEWAL
  MAINTENANCE_SLA_BREACH
  MAINTENANCE_COMPLETED
  NEW_MESSAGE
  LEASE_NOTICE
  PAYMENT_RECEIVED
  APPLICATION_STATUS_CHANGE
  SYSTEM_ANNOUNCEMENT
  INSPECTION_SCHEDULED
  INSPECTION_COMPLETED
}

model UnitInspection {
  id            Int                   @id @default(autoincrement())
  unit          Unit                  @relation(fields: [unitId], references: [id])
  unitId        Int
  property      Property              @relation(fields: [propertyId], references: [id])
  propertyId    Int
  type          InspectionType
  status        InspectionStatus      @default(SCHEDULED)
  scheduledDate DateTime
  completedDate DateTime?
  inspector     User?                 @relation("Inspector", fields: [inspectorId], references: [id])
  inspectorId   Int?
  createdBy     User                  @relation("CreatedBy", fields: [createdById], references: [id])
  createdById   Int
  notes         String?
  findings      Json?
  photos        UnitInspectionPhoto[]
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  @@index([unitId])
  @@index([propertyId])
  @@index([status])
  @@index([scheduledDate])
  @@index([inspectorId])
}

model UnitInspectionPhoto {
  id           Int            @id @default(autoincrement())
  inspection   UnitInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  inspectionId Int
  url          String
  caption      String?
  uploadedBy   User?          @relation(fields: [uploadedById], references: [id])
  uploadedById Int?
  createdAt    DateTime       @default(now())

  @@index([inspectionId])
}

enum InspectionType {
  MOVE_IN
  MOVE_OUT
  ROUTINE
  DAMAGE
  COMPLIANCE
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model ScheduleEvent {
  id          Int               @id @default(autoincrement())
  type        ScheduleEventType
  title       String
  date        DateTime
  priority    EventPriority     @default(MEDIUM)
  description String?
  status      String?           @default("SCHEDULED")
  property    Property?         @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  propertyId  Int?
  unit        Unit?             @relation(fields: [unitId], references: [id], onDelete: SetNull)
  unitId      Int?
  tenant      User?             @relation("ScheduleEventTenant", fields: [tenantId], references: [id], onDelete: SetNull)
  tenantId    Int?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([date])
  @@index([type])
  @@index([priority])
  @@index([propertyId])
}

enum ScheduleEventType {
  TOUR
  MOVE_IN
  MOVE_OUT
  LEASE_EXPIRATION
  LEASE_RENEWAL
  INSPECTION
  MAINTENANCE
}

enum EventPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
